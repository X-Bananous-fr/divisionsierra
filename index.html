<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Division Sierra - Canaux</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Dark mode - all text white */
    :root{
      --bg:#0b1220;
      --panel:#0f1724;
      --muted:#ffffff;
      --card:#071425;
      --accent:#0d6efd;
      --text:#ffffff;
      --border:#17202a;
      --panic-glow: rgba(179,45,45,0.95);
    }
    html,body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); }
    body { display:flex; align-items:stretch; flex-direction:row; }

    /* Sidebar: on narrow screens it will stack above main (no retractable menu) */
    #sidebar { width: 320px; border-right:1px solid var(--border); padding:1rem; background:linear-gradient(180deg,var(--panel),#0b1320); transition: none; box-sizing:border-box; }
    @media (max-width: 768px) {
      body { flex-direction:column; }
      #sidebar { position:relative; left:auto; top:auto; bottom:auto; z-index:auto; width:100%; transform:none; box-shadow:none; border-right:none; border-bottom:1px solid var(--border); }
      #main { padding:1rem; }
      /* hide any toggle buttons when stacking */
      .toggle-sidebar { display:none !important; }
      .sidebar-overlay { display:none !important; }
    }

    /* ensure toggle-button hidden by default (we removed retractable behaviour) */
    .toggle-sidebar { display:none; }

    #main { flex:1; display:flex; flex-direction:column; padding:1rem; box-sizing:border-box; }
    #messages { flex:1; overflow:auto; border:1px solid var(--border); padding:1rem; border-radius:6px; background:var(--card); }
    .msg { margin-bottom:.6rem; }
    .msg .meta { font-size:.85rem; color:var(--muted); display:flex; gap:.5rem; align-items:center; }
    .msg .meta small { color:var(--text) !important; opacity:.85; } /* dates white */
    .channel-item { cursor:pointer; padding:.35rem .5rem; border-radius:6px; display:flex; gap:.5rem; align-items:center; color:var(--text); }
    .channel-item.active { background: rgba(13,110,253,0.15); color:var(--text); }
    .channel-icon { width:20px; text-align:center; }
    .group-title { margin-top:.6rem; margin-bottom:.2rem; font-weight:600; font-size:.9rem; color:var(--text); }
    .small-sep { height:1px; background:var(--border); margin:.35rem 0 .6rem 0; }
    .muted { color:var(--text); font-size:.85rem; }
    #brand { font-weight:700; display:flex; align-items:center; gap:.5rem; color:var(--text); align-items:center; }
    input.form-control { background:transparent; border:1px solid var(--border); color:var(--text); }
    /* make placeholders visible in white across engines */
    ::-webkit-input-placeholder { color: rgba(255,255,255,0.55) !important; }
    ::-moz-placeholder { color: rgba(255,255,255,0.55) !important; opacity:1; }
    :-ms-input-placeholder { color: rgba(255,255,255,0.55) !important; }
    ::placeholder { color: rgba(255,255,255,0.55) !important; }
    .input-group .btn { border:1px solid var(--border); color:var(--text); background:transparent; }
    #main h5,#main small { color:var(--text); }
    #status { color: var(--text); } /* message counter white */
    .content { color:var(--text) !important; white-space:pre-wrap; }
    .meta strong { color:var(--text) !important; }
    /* ensure bootstrap .text-muted used on some elements is white */
    .text-muted { color: rgba(255,255,255,0.75) !important; }
    .btn-danger { background:#b32d2d; border-color:#8f2525; color:#fff; }
    .btn-primary { background:var(--accent); border-color:var(--accent); color:#fff; }

    /* Panic styles and blink animation */
    @keyframes panicBlink {
      0% { background: var(--panic-glow); transform: translateY(0); }
      50% { background: rgba(255,255,255,0.05); transform: translateY(-1px); }
      100% { background: var(--panic-glow); transform: translateY(0); }
    }
    .panic { animation: panicBlink 1s linear infinite; color:#fff; padding:.5rem; border-radius:6px; }
    /* Channel notify indicator (non-panic only) */
    .channel-item.notify { box-shadow: 0 0 8px rgba(179,45,45,0.9) inset; border-left:4px solid #ff6b6b; position:relative; }
    .channel-item.notify::after { content:''; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:10px; height:10px; background:#ff6b6b; border-radius:50%; box-shadow:0 0 6px rgba(255,107,107,0.9); }
    /* Panic alert modal content */
    .modal-content { background:var(--panel); color:var(--text); border:1px solid var(--border); }
    .text-white { color:var(--text) !important; }
  </style>
</head>
<body>
  <div id="sidebar" class="hide-on-mobile">
    <div id="brand" class="mb-3">
      <i class="fa-solid fa-users" style="font-size:1.25rem;"></i>
      <div style="flex:1;">
        <div>Division Sierra</div>
        <div class="muted" style="font-size:.85rem">Communication interne</div>
      </div>
      <!-- bouton de fermeture masqué (plus de menu retractable) -->
      <button id="sidebarClose" class="btn btn-sm btn-outline-secondary" title="Cacher le menu" aria-label="Cacher le menu" style="display:none;"><i class="fa-solid fa-chevron-left"></i></button>
    </div>

    <h5>Connexion</h5>
    <form id="authForm" class="mb-3" onsubmit="return false;">
      <!-- STEP: enter pseudo -->
      <div id="step-pseudo">
        <div class="mb-2">
          <input id="pseudo" class="form-control" placeholder="Pseudo / Indicatif" required />
        </div>
        <div class="d-flex gap-2">
          <button id="pseudoNext" type="button" class="btn btn-primary w-100">Suivant</button>
        </div>
      </div>

      <!-- STEP: login (existing user) -->
      <div id="step-login" style="display:none;">
        <div class="mb-2">
          <div class="mb-1">Pseudo: <strong id="stepLoginPseudo"></strong></div>
          <input id="loginCode" type="text" class="form-control" placeholder="Code 6 chiffres" inputmode="numeric" maxlength="6" title="6 chiffres" />
        </div>
        <div class="d-flex gap-2">
          <button id="loginBtn" type="button" class="btn btn-success w-100">Se connecter</button>
          <button id="loginBack" type="button" class="btn btn-outline-secondary">Retour</button>
        </div>
      </div>

      <!-- STEP: create (new user) -->
      <div id="step-create" style="display:none;">
        <div class="mb-2">
          <div class="mb-1">Créer: <strong id="stepCreatePseudo"></strong></div>
          <input id="createIndicatif" type="text" class="form-control mb-1" placeholder="Indicatif (ex. Overwatch)" />
          <input id="createCode" type="text" class="form-control mb-1" placeholder="Code 6 chiffres" inputmode="numeric" maxlength="6" title="6 chiffres" />
          <input id="createNumber" type="number" class="form-control mb-1" placeholder="Nombre à afficher (ex: 42)" min="0" />
          <input id="createConfirm" type="text" class="form-control" placeholder="Confirmer le code" inputmode="numeric" maxlength="6" title="6 chiffres" />
        </div>
        <div class="d-flex gap-2">
          <button id="createBtn" type="button" class="btn btn-primary w-100">Créer un compte</button>
          <button id="createBack" type="button" class="btn btn-outline-secondary">Retour</button>
        </div>
      </div>
    </form>

    <div id="userInfo" style="display:none;">
      <div class="mb-2">Connecté comme <strong id="userPseudo"></strong></div>
      <button id="logoutBtn" class="btn btn-sm btn-outline-secondary mb-3">Se déconnecter</button>
    </div>

    <div id="channelsContainer" style="display:none;">
      <h6 class="text-white">Canaux</h6>

      <div class="group-title">Général</div>
      <div id="channelsList" class="mb-2"></div>

      <div class="small-sep"></div>
      <div class="group-title">Squads</div>
      <div id="channelsSquad" class="mb-2"></div>

      <div class="small-sep"></div>
      <div class="group-title">Entraînement</div>
      <div id="channelsTrain" class="mb-2"></div>
    </div>
  </div>

  <!-- overlay removed (no retractable menu) -->
  <div class="sidebar-overlay" id="sidebarOverlay" style="display:none;"></div>

  <div id="main">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="d-flex align-items-center gap-2">
        <!-- toggle hidden since menu is not retractable -->
        <button id="sidebarToggle" class="btn btn-sm btn-outline-secondary toggle-sidebar" title="Afficher/cacher le menu" style="display:none;"><i class="fa-solid fa-bars"></i></button>
        <h5 id="currentChannel" class="m-0">Aucun canal</h5>
      </div>
      <small id="status" class="text-muted">—</small>
    </div>

    <div id="messages" aria-live="polite"></div>

    <!-- send form: no submit button (enter only). panicBtn shown only for squads -->
    <form id="sendForm" class="mt-3 d-none" autocomplete="off">
      <div class="input-group">
        <input id="messageInput" class="form-control" placeholder="Écrire un message... (Entrée pour envoyer)" required />
        <button id="panicBtn" type="button" class="btn btn-danger d-none" title="Panic - demander position"><i class="fa-solid fa-triangle-exclamation"></i>&nbsp;PANIC</button>
      </div>
    </form>
  </div>

  <!-- Panic modal (demande position) -->
  <div class="modal fade" id="panicModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Panic - Indiquer la position</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1)"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">Entrez la position (format libre). Cette action enverra un message d'urgence dans le canal.</div>
          <input id="panicPosition" type="text" class="form-control" placeholder="Ex: Grid 12A / 48.8566,2.3522" />
          <div id="panicError" class="mt-2 text-danger" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button id="panicCancel" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
          <button id="panicConfirm" type="button" class="btn btn-danger">Envoyer Panic</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Panic alert modal (pour tous les clients) -->
  <div class="modal fade" id="panicAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ALERTE PANIC</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1)"></button>
        </div>
        <div class="modal-body">
          <div id="panicAlertText" class="text-white"></div>
        </div>
        <div class="modal-footer">
          <button id="panicGoto" type="button" class="btn btn-primary">Voir le canal</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Info modal (remplace alert()) -->
  <div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter:invert(1)"></button>
        </div>
        <div class="modal-body">
          <div id="infoText" class="text-white"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://ojbdzuxogyjmecgaqack.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qYmR6dXhvZ3lqbWVjZ2FxYWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNjI2ODcsImV4cCI6MjA3NTkzODY4N30.A2wbq6lpEHMl8emgKmO00g5cXnJYx7wpzL-zMPPh0cw';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Use Font Awesome icon classes (no emojis)
    const CHANNELS = [
      { id: 'general', name: 'Com. Général', icon: 'fa-solid fa-comments' },
      ...Array.from({length:6}, (_,i)=>({ id:`squad-${i+1}`, name:`Com. Squad ${i+1}`, icon: 'fa-solid fa-shield' })),
      ...Array.from({length:4}, (_,i)=>({ id:`train-${i+1}`, name:`Com. Entrainement ${i+1}`, icon: 'fa-solid fa-bullseye' })),
    ];

    // DOM refs
    const pseudoInput = document.getElementById('pseudo');
    const loginCode = document.getElementById('loginCode');
    const createIndicatif = document.getElementById('createIndicatif');
    const createCode = document.getElementById('createCode');
    const createNumber = document.getElementById('createNumber');
    const createConfirm = document.getElementById('createConfirm');
    const userInfo = document.getElementById('userInfo');
    const userPseudoEl = document.getElementById('userPseudo');
    const logoutBtn = document.getElementById('logoutBtn');
    const channelsContainer = document.getElementById('channelsContainer');
    const channelsList = document.getElementById('channelsList');
    const channelsSquad = document.getElementById('channelsSquad');
    const channelsTrain = document.getElementById('channelsTrain');
    const currentChannelEl = document.getElementById('currentChannel');
    const messagesEl = document.getElementById('messages');
    const sendForm = document.getElementById('sendForm');
    const messageInput = document.getElementById('messageInput');
    const statusEl = document.getElementById('status');

    // steps
    const stepPseudo = document.getElementById('step-pseudo');
    const stepLogin = document.getElementById('step-login');
    const stepCreate = document.getElementById('step-create');
    const stepLoginPseudo = document.getElementById('stepLoginPseudo');
    const stepCreatePseudo = document.getElementById('stepCreatePseudo');
    const pseudoNext = document.getElementById('pseudoNext');
    const loginBtn = document.getElementById('loginBtn');
    const loginBack = document.getElementById('loginBack');
    const createBtn = document.getElementById('createBtn');
    const createBack = document.getElementById('createBack');

    // panic
    const panicBtn = document.getElementById('panicBtn');
    const panicModalEl = document.getElementById('panicModal');
    const panicPosition = document.getElementById('panicPosition');
    const panicConfirm = document.getElementById('panicConfirm');
    const panicError = document.getElementById('panicError');
    const bsPanicModal = new bootstrap.Modal(panicModalEl, { backdrop: 'static' });

    // panic alert modal and info modal
    const panicAlertModalEl = document.getElementById('panicAlertModal');
    const bsPanicAlertModal = new bootstrap.Modal(panicAlertModalEl, { backdrop: 'static' });
    const panicAlertText = document.getElementById('panicAlertText');
    const panicGoto = document.getElementById('panicGoto');

    const infoModalEl = document.getElementById('infoModal');
    const bsInfoModal = new bootstrap.Modal(infoModalEl, { backdrop: true });
    const infoText = document.getElementById('infoText');

    let me = null;
    let selectedChannel = null;
    let subscription = null;
    let windowFocused = true;

    // track focus for notification logic
    window.addEventListener('focus', ()=> windowFocused = true);
    window.addEventListener('blur', ()=> windowFocused = false);

    function showInfo(msg){
      infoText.textContent = msg;
      bsInfoModal.show();
    }

    // message notification short sound
    function playMsgSound(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        const g = ctx.createGain();
        g.gain.value = 0.12;
        g.connect(ctx.destination);
        const o = ctx.createOscillator();
        o.type = 'sine';
        o.frequency.setValueAtTime(1200, now);
        o.connect(g);
        o.start(now);
        o.stop(now + 0.12);
        setTimeout(()=>{ try{ ctx.close(); }catch(e){} }, 300);
      } catch(e){}
    }

    // longer panic sound (more urgent, longer)
    function playPanicSound(){
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        const g = ctx.createGain();
        g.gain.value = 0.18;
        g.connect(ctx.destination);
        // pattern: descending tones + drone (longer)
        const drone = ctx.createOscillator();
        drone.type = 'sawtooth';
        drone.frequency.setValueAtTime(700, now);
        const droneGain = ctx.createGain();
        droneGain.gain.value = 0.04;
        drone.connect(droneGain);
        droneGain.connect(g);
        drone.start(now);
        const freqs = [1600, 1400, 1200, 1000, 900, 800];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          o.type = 'sine';
          o.frequency.setValueAtTime(f, now + i*0.45);
          const og = ctx.createGain();
          og.gain.value = 0.16;
          o.connect(og);
          og.connect(g);
          o.start(now + i*0.45);
          o.stop(now + i*0.45 + 0.35);
        });
        setTimeout(()=>{ try{ drone.stop(); ctx.close(); }catch(e){} }, freqs.length*450 + 600);
      } catch(e){}
    }

    // desktop notification helper
    function showDesktopNotification(title, body, channelId){
      if (Notification && Notification.permission === 'granted') {
        try {
          const n = new Notification(title, { body, silent: true });
          n.onclick = () => {
            window.focus();
            if (channelId) selectChannel(channelId);
            n.close();
          };
        } catch(e){}
      }
    }

    // simple local profiles store (per pseudo)
    function saveLocalProfile(pseudo, profile){
      const all = JSON.parse(localStorage.getItem('profiles') || '{}');
      all[pseudo] = profile;
      localStorage.setItem('profiles', JSON.stringify(all));
    }
    function loadLocalProfile(pseudo){
      const all = JSON.parse(localStorage.getItem('profiles') || '{}');
      return all[pseudo] || null;
    }

    // Render channels split into groups
    function renderChannels() {
      channelsList.innerHTML = '';
      channelsSquad.innerHTML = '';
      channelsTrain.innerHTML = '';
      CHANNELS.forEach(ch=>{
        const el = makeChannelEl(ch);
        if (ch.id === 'general') channelsList.appendChild(el);
        else if (ch.id.startsWith('squad-')) channelsSquad.appendChild(el);
        else if (ch.id.startsWith('train-')) channelsTrain.appendChild(el);
      });
    }

    function makeChannelEl(ch) {
      const div = document.createElement('div');
      div.className = 'channel-item';
      div.dataset.id = ch.id;
      div.innerHTML = `<i class="${ch.icon} channel-icon"></i><span>${ch.name}</span>`;
      div.addEventListener('click', ()=>selectChannel(ch.id));
      return div;
    }

    function highlightActive() {
      document.querySelectorAll('.channel-item').forEach(el=>{
        el.classList.toggle('active', el.dataset.id === selectedChannel);
        if (el.dataset.id === selectedChannel) el.classList.remove('notify');
      });
    }

    async function selectChannel(channelId) {
      selectedChannel = channelId;
      const ch = CHANNELS.find(c=>c.id===channelId);
      currentChannelEl.textContent = ch ? ch.name : channelId;
      highlightActive();
      messagesEl.innerHTML = '';
      // if not logged, do not show messages or channels
      if (!me) {
        sendForm.classList.add('d-none');
        messagesEl.innerHTML = '<div class="muted">Connectez-vous pour voir les messages.</div>';
        statusEl.textContent = '—';
        stopRealtime();
        return;
      }
      sendForm.classList.remove('d-none');

      // Panic button: only visible for squads
      if (channelId && channelId.startsWith('squad-')) panicBtn.classList.remove('d-none');
      else panicBtn.classList.add('d-none');

      statusEl.textContent = 'chargement...';
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('channel', channelId)
        .order('created_at', { ascending: true })
        .limit(500);
      if (error) {
        console.error(error);
        statusEl.textContent = 'erreur chargement';
        return;
      }
      data.forEach(renderMessage);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      statusEl.textContent = `${data.length} messages`;
      // clear unread marks in DB for this channel
      try { await supabase.from('unreads').delete().eq('channel', channelId); } catch(e){}
      startRealtime();
    }

    function renderMessage(msg) {
      if (!msg || !msg.id) {
        msg = { ...msg, id: 'tmp-' + Math.random().toString(36).slice(2), created_at: msg.created_at || new Date().toISOString() };
      }
      if (document.querySelector(`[data-id="${msg.id}"]`)) return;
      const el = document.createElement('div');
      el.className = 'msg';
      el.dataset.id = msg.id;
      const isPanic = (msg.content || '').startsWith('[PANIC]');
      // lookup profile for display extras
      const profile = loadLocalProfile(msg.pseudo);
      const displayExtra = profile ? `${profile.indicatif ? ' · ' + profile.indicatif : ''}${profile.number ? ' #' + profile.number : ''}` : '';
      el.innerHTML = `
        <div class="meta"><strong>${escapeHtml(msg.pseudo)}</strong>${ displayExtra ? `<small class="text-muted">${escapeHtml(displayExtra)}</small>` : '' } · <small class="text-muted">${new Date(msg.created_at).toLocaleString()}</small></div>
        <div class="content">${escapeHtml(msg.content)}</div>
      `;
      if (isPanic) el.classList.add('panic');
      messagesEl.appendChild(el);
    }

    // helper to escape HTML
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Submit via Enter only
    sendForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!me || !selectedChannel) return;
      const content = messageInput.value.trim();
      if (!content) return;
      messageInput.value = '';
      const payload = {
        channel: selectedChannel,
        user_id: me.id,
        pseudo: me.pseudo,
        content
      };
      const res = await supabase.from('messages').insert([payload]).select().single();
      if (res.error) {
        console.error('send error', res.error);
        showInfo('Erreur envoi message.');
        return;
      }
      renderMessage(res.data);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    function startRealtime() {
      if (!me) return;
      if (subscription) return;
      subscription = supabase.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
          const msg = payload.new;
          const isPanic = (msg.content || '').startsWith('[PANIC]');
          if (msg.channel !== selectedChannel) {
            // DO NOT add panic notify icon: panic triggers global modal + sound only and no icon
            if (!isPanic) {
              const chEl = document.querySelector(`.channel-item[data-id="${msg.channel}"]`);
              if (chEl) chEl.classList.add('notify');
              // store unread message row in SQL
              try {
                await supabase.from('unreads').insert([{ message_id: msg.id, channel: msg.channel, content: msg.content, created_at: msg.created_at }]);
              } catch(e){}
            } else {
              // panic for another channel: still trigger global alert (no channel icon)
              triggerPanicAlert(msg.channel, msg.content);
            }
            // notify user if not focused or page hidden
            if (!windowFocused || document.hidden) {
              playMsgSound();
              const short = (msg.content || '').slice(0, 120);
              showDesktopNotification(`Nouveau message — ${msg.channel}`, short, msg.channel);
            }
            return;
          }
          // same channel: render (avoid duplicates)
          if (!document.querySelector(`[data-id="${msg.id}"]`)) {
            renderMessage(msg);
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
          // if panic in our channel: trigger global alert behavior (no extra icon)
          if (isPanic) {
            triggerPanicAlert(msg.channel, msg.content);
          }
        })
        .subscribe();
    }

    function stopRealtime() {
      if (!subscription) return;
      supabase.removeChannel(subscription);
      subscription = null;
    }

    // Panic cooldown persisted in SQL (plus local fallback)
    async function allowedPanic(){
      // check server cooldown (panic_cooldowns table) for this user
      try {
        const { data } = await supabase.from('panic_cooldowns').select('last_panic_at').eq('user_id', me ? me.id : -1).limit(1).single();
        const last = data && data.last_panic_at ? new Date(data.last_panic_at).getTime() : parseInt(localStorage.getItem('lastPanicAt')||'0',10);
        const now = Date.now();
        const diff = now - last;
        if (diff >= 300000) return { ok:true };
        return { ok:false, remaining: 300000 - diff };
      } catch(e){
        // fallback to local
        const last = parseInt(localStorage.getItem('lastPanicAt') || '0', 10);
        const now = Date.now();
        const diff = now - last;
        if (diff >= 300000) return { ok:true };
        return { ok:false, remaining: 300000 - diff };
      }
    }

    // show panic UI: play sound, show modal, highlight channel
    function triggerPanicAlert(channelId, content){
      playPanicSound();
      const ch = CHANNELS.find(c=>c.id===channelId);
      panicAlertText.textContent = `${ch ? ch.name : channelId} — ${content}`;
      panicGoto.onclick = () => { bsPanicAlertModal.hide(); selectChannel(channelId); };
      bsPanicAlertModal.show();
    }

    // Panic flow - show modal, collect position, send special message
    panicBtn.addEventListener('click', ()=> {
      panicPosition.value = '';
      panicError.style.display = 'none';
      bsPanicModal.show();
      setTimeout(()=>panicPosition.focus(), 200);
    });

    panicConfirm.addEventListener('click', async () => {
      const pos = (panicPosition.value || '').trim();
      panicError.style.display = 'none';
      if (!pos) {
        panicError.textContent = 'La position est requise.';
        panicError.style.display = '';
        return;
      }
      if (!me || !selectedChannel) {
        panicError.textContent = 'Impossible d\'envoyer pour le moment.';
        panicError.style.display = '';
        return;
      }
      const ok = await allowedPanic();
      if (!ok.ok) {
        const sec = Math.ceil(ok.remaining/1000);
        showInfo(`Panic indisponible pour ${sec} secondes.`);
        return;
      }
      const payload = {
        channel: selectedChannel,
        user_id: me.id,
        pseudo: me.pseudo,
        content: `[PANIC] Position: ${pos}`
      };
      const res = await supabase.from('messages').insert([payload]).select().single();
      if (res.error) {
        console.error('panic send error', res.error);
        panicError.textContent = 'Erreur envoi.';
        panicError.style.display = '';
        return;
      }
      // record cooldown locally and in SQL
      localStorage.setItem('lastPanicAt', String(Date.now()));
      try {
        // insert into panics table for history
        await supabase.from('panics').insert([{ message_id: res.data.id, channel: selectedChannel, user_id: me.id, pseudo: me.pseudo, position: pos, created_at: res.data.created_at }]);
        // upsert cooldown
        await supabase.from('panic_cooldowns').upsert([{ user_id: me.id, last_panic_at: new Date().toISOString() }], { onConflict: 'user_id' });
      } catch(e){ console.error('panic sql record error', e); }
      renderMessage(res.data);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      bsPanicModal.hide();
      // trigger global alert (no channel icon)
      triggerPanicAlert(selectedChannel, res.data.content);
    });

    // Auth STEP FLOW - replace alerts by modals
    pseudoNext.addEventListener('click', async ()=>{
      const pseudo = (pseudoInput.value || '').trim();
      if (!pseudo) { showInfo('Entrez un pseudo.'); return; }
      const { data } = await supabase.from('users').select('id,pseudo,code').eq('pseudo', pseudo).limit(1).single();
      if (data) {
        stepPseudo.style.display = 'none';
        stepCreate.style.display = 'none';
        stepLogin.style.display = '';
        stepLoginPseudo.textContent = pseudo;
        loginCode.focus();
      } else {
        stepPseudo.style.display = 'none';
        stepLogin.style.display = 'none';
        stepCreate.style.display = '';
        stepCreatePseudo.textContent = pseudo;
        createIndicatif.focus();
      }
    });

    loginBack.addEventListener('click', ()=> {
      stepLogin.style.display = 'none';
      stepPseudo.style.display = '';
      pseudoInput.focus();
    });
    createBack.addEventListener('click', ()=> {
      stepCreate.style.display = 'none';
      stepPseudo.style.display = '';
      pseudoInput.focus();
    });

    loginBtn.addEventListener('click', async ()=>{
      const pseudo = stepLoginPseudo.textContent;
      const code = (loginCode.value || '').trim();
      if (!/^\d{6}$/.test(code)) { showInfo('Le code doit être 6 chiffres.'); return; }
      const { data, error } = await supabase.from('users').select('*').eq('pseudo', pseudo).limit(1).single();
      if (error || !data) { showInfo('Utilisateur introuvable.'); return; }
      if (data.code !== code) { showInfo('Code incorrect.'); return; }
      me = data;
      // restore local profile if present
      me.profile = loadLocalProfile(me.pseudo);
      localStorage.setItem('user', JSON.stringify(me));
      // request notification permission
      if (Notification && Notification.permission !== 'granted') Notification.requestPermission();
      onLoggedIn();
    });

    createBtn.addEventListener('click', async ()=>{
      const pseudo = stepCreatePseudo.textContent;
      const indicatif = (createIndicatif.value || '').trim();
      const number = (createNumber.value || '').trim();
      const code = (createCode.value || '').trim();
      const confirm = (createConfirm.value || '').trim();
      if (!/^\d{6}$/.test(code) || !/^\d{6}$/.test(confirm)) { showInfo('Le code doit être 6 chiffres.'); return; }
      if (code !== confirm) { showInfo('Les codes ne correspondent pas.'); return; }
      const ins = await supabase.from('users').insert([{ pseudo, code }]).select().single();
      if (ins.error) { console.error(ins.error); showInfo('Impossible de créer le compte. Le pseudo est peut‑être déjà pris.'); return; }
      me = ins.data;
      // save local profile (indicatif + number) for display in chat
      saveLocalProfile(me.pseudo, { indicatif: indicatif || '', number: number ? String(number) : '' });
      me.profile = loadLocalProfile(me.pseudo);
      localStorage.setItem('user', JSON.stringify(me));
      // request notification permission
      if (Notification && Notification.permission !== 'granted') Notification.requestPermission();
      onLoggedIn();
    });

    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem('user');
      me = null;
      userInfo.style.display = 'none';
      channelsContainer.style.display = 'none';
      stepPseudo.style.display = '';
      stepLogin.style.display = 'none';
      stepCreate.style.display = 'none';
      sendForm.classList.add('d-none');
      messagesEl.innerHTML = '<div class="muted">Connectez-vous pour voir les messages.</div>';
      statusEl.textContent = '—';
      stopRealtime();
    });

    function onLoggedIn(){
      userPseudoEl.textContent = me.pseudo;
      userInfo.style.display = '';
      stepPseudo.style.display = 'none';
      stepLogin.style.display = 'none';
      stepCreate.style.display = 'none';
      // attach local profile if present
      me.profile = loadLocalProfile(me.pseudo);
      channelsContainer.style.display = '';
      renderChannels();
      sendForm.classList.toggle('d-none', !selectedChannel);
      if (selectedChannel && selectedChannel.startsWith('squad-')) panicBtn.classList.remove('d-none'); else panicBtn.classList.add('d-none');
      // auto-select general if none
      if (!selectedChannel) selectChannel('general');
    }

    // Init
    (function init(){
      const stored = localStorage.getItem('user');
      if (stored) {
        try { me = JSON.parse(stored); } catch(e){ localStorage.removeItem('user'); me = null; }
      }
      if (me) {
        onLoggedIn();
        // ensure realtime started when selecting default
        selectChannel('general');
      } else {
        // hide channels and messages until login
        channelsContainer.style.display = 'none';
        messagesEl.innerHTML = '<div class="muted">Connectez-vous pour voir les messages.</div>';
        statusEl.textContent = '—';
      }
    })();

    window.addEventListener('beforeunload', ()=> stopRealtime());
  </script>
</body>
</html>
